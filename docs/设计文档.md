数据分层处理系统设计文档
1. 系统概述
本系统采用数据分层架构设计，基于 Flink 流处理框架实现用户行为数据的实时处理与分析。系统从原始数据采集（ODS 层）到数据清洗标准化（DWD 层），再到数据汇总统计（DWS 层），最终形成业务指标（ADS 层），实现了完整的数据处理链路。
2. 分层设计
2.1 ODS 层（操作数据存储层）
核心功能
负责原始用户行为数据的生成与接入
提供基础数据输出能力，支持自定义 Sink 扩展
主要类结构
ODSUserAction：原始用户行为数据实体类
包含核心字段：actionId、userId、shopId、timestamp、actionType、metadata
提供完整的 getter/setter 方法及 toString 实现
CustomPrintSink：自定义数据输出组件
扩展 RichSinkFunction，支持格式化输出
核心方法：createStream()用于生成原始数据流
数据处理流程
创建 Flink 执行环境
生成原始用户行为数据流
通过 print 或自定义 Sink 输出数据
执行 Flink 任务
2.2 DWD 层（数据明细层）
核心功能
从 ODS 层接入原始数据并进行清洗
对数据进行标准化处理
按行为类型拆分数据流
过滤并标记无效 / 异常数据
主要类结构
ActionType：标准化行为类型枚举
包含 VISIT、INTERACTION、PAYMENT、FOLLOW 四种行为类型
DWDUserAction：标准化后的用户行为数据类
在 ODS 基础上新增 statDate 字段（统计日期）
标准化 amount 和 relatedId 字段
DWDStreams：DWD 层输出流封装类
包含各类行为流（访问、互动、支付、关注）及全量流、无效数据流
数据处理流程
数据清洗：过滤缺失核心字段的异常数据
数据标准化：统一格式，新增统计日期
行为分类：按 ActionType 拆分数据流
无效数据处理：通过侧输出流收集无效 / 异常数据
封装并返回所有处理后的数据流
2.3 DWS 层（数据仓库汇总层）
核心功能
基于 DWD 层数据进行指标计算
按业务维度进行数据汇总
为 ADS 层提供聚合数据支持
主要类结构
各类汇总数据类：
ShopCustomerDWS：店铺客户数汇总
NewVisitDWS：新访用户汇总
ReturnVisitDWS：回访用户汇总
OldCustomerDWS：老客户汇总
SalesDWS：销售汇总
DWSStreams：DWS 层输出流封装类
核心指标计算
店铺客户数统计
新访用户指标计算（访问次数、支付次数等）
回访用户指标计算
老客户指标计算（复购率、总消费等）
销售数据汇总（总销售额、各类型用户贡献等）
2.4 ADS 层（应用数据服务层）
核心功能
基于 DWS 层数据进行最终指标聚合
提供面向业务的核心指标
支持直接应用于业务决策
主要类结构
各类核心指标数据类：
ShopCustomerADS：店铺客户核心指标
NewVisitADS：新访客户核心指标
ReturnVisitADS：回访客户核心指标
OldCustomerADS：老客户核心指标
OldCustomerAggregate：老客户指标聚合器
实现 AggregateFunction 接口，完成指标聚合计算
核心指标
客户数量指标（总客户数、新客户数等）
访问转化指标（支付率、平均客单价等）
用户价值指标（会员数量、高价值客户占比等）
销售贡献指标（各类型用户销售额占比等）
3. 数据流转关系
数据流向：ODS 层 → DWD 层 → DWS 层 → ADS 层
处理逻辑：
原始数据经过清洗标准化形成明细数据
明细数据按业务维度汇总形成汇总数据
汇总数据聚合计算形成最终业务指标
关键关联：
各层通过数据流进行衔接
以 shopId、userId、statDate 作为核心关联维度
行为类型（ActionType）作为重要分类依据
4. 技术特性
实时处理：基于 Flink 流处理框架，支持实时数据处理
状态管理：使用 Flink 状态管理机制（如 ValueState）保存中间计算结果
可扩展性：各层职责明确，便于功能扩展
可监控性：为每个算子设置 name 和 uid，便于 Flink UI 监控和状态恢复
5. 应用场景
实时用户行为分析
客户价值评估
销售数据实时监控
复购率、转化率等关键指标追踪
新老客户行为特征对比分析